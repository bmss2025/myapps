let geojsonData=null,visibleColumns={},filteredFeatures=[],selectedRowIndex=null;document.getElementById("fileInput").addEventListener("change",handleFile),document.getElementById("fontSizeSelect").addEventListener("change",e=>{document.documentElement.style.setProperty("--font-size",e.target.value)}),document.getElementById("toggleColumnsBtn").addEventListener("click",()=>{let e=document.getElementById("columnList");e.style.display="block"===e.style.display?"none":"block"}),document.getElementById("searchInput").addEventListener("input",handleSearch),document.getElementById("toggleMapBtn").addEventListener("click",toggleMap),document.getElementById("exportExcelBtn").addEventListener("click",()=>{if(!geojsonData)return alert("No data to export.");let e=filteredFeatures||geojsonData.features,t=Object.keys(e[0].properties).filter(e=>visibleColumns[e]),a=e.map(e=>{let a={};return t.forEach(t=>a[t]=e.properties[t]??""),a}),n=XLSX.utils.json_to_sheet(a),r=XLSX.utils.book_new();XLSX.utils.book_append_sheet(r,n,"Attributes"),XLSX.writeFile(r,"geojson_attributes.xlsx")});const MapPreview=(()=>{let e,t,a,n;function r(){e||(e=L.map("map").setView([20,80],4),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}).addTo(e))}function l(a,l){e||r(),a&&(t&&t.remove(),n=l,t=L.geoJSON(a,{style:{color:"#0078d4",weight:2,fillOpacity:.2},pointToLayer:(e,t)=>L.circleMarker(t,{radius:5,color:"#0078d4"}),onEachFeature(e,t){t.on("click",()=>{o(e),"function"==typeof n&&n(e)})}}).addTo(e),setTimeout(()=>{try{let a=t.getBounds();a.isValid()&&e.fitBounds(a)}catch{e.setView([20,80],4)}},200))}function o(t){e&&(a&&a.remove(),a=L.geoJSON(t,{style:{color:"red",weight:3,fillOpacity:.3},pointToLayer:(e,t)=>L.circleMarker(t,{radius:6,color:"red",weight:3})}).addTo(e),setTimeout(()=>{try{e.fitBounds(a.getBounds(),{maxZoom:12})}catch(n){let r=t.geometry.coordinates;Array.isArray(r)&&r.length>=2&&e.setView([r[1],r[0]],10)}},150))}function i(){e&&e.invalidateSize()}return{loadGeoJSON:l,highlightFeature:o,refresh:i,initMap:r}})();async function handleFile(e){let t=e.target.files[0];if(!t)return;let a=await t.text();geojsonData=JSON.parse(a);let n=geojsonData.features;if(!n?.length)return alert("No features found in GeoJSON.");let r=Object.keys(n[0].properties);visibleColumns=Object.fromEntries(r.map(e=>[e,!0])),filteredFeatures=n,renderColumnList(r),renderTable(),MapPreview.loadGeoJSON(geojsonData,handleMapFeatureClick),document.getElementById("saveBtn").style.display="inline-block",document.getElementById("exportExcelBtn").style.display="inline-block"}function renderColumnList(e){let t=document.getElementById("columnList");t.innerHTML="",e.forEach(e=>{let a=document.createElement("label");a.innerHTML=`<input type="checkbox" checked data-key="${e}"><span>${e}</span>`,t.appendChild(a)}),t.addEventListener("change",e=>{if(e.target.matches("input[type=checkbox]")){let t=e.target.dataset.key;visibleColumns[t]=e.target.checked,renderTable()}})}function handleSearch(e){let t=e.target.value.trim().toLowerCase();filteredFeatures=t?geojsonData.features.filter(e=>Object.entries(e.properties).some(([e,a])=>visibleColumns[e]&&String(a??"").toLowerCase().includes(t))):geojsonData.features,renderTable()}function renderTable(){let e=filteredFeatures,t=document.getElementById("tableContainer");if(!e.length){t.innerHTML="<p style='padding:10px;'>No matching records.</p>";return}let a=Object.keys(e[0].properties).filter(e=>visibleColumns[e]),n="<table><thead><tr>";a.forEach(e=>n+=`<th class="resizable">${e}<div class="resize-handle"></div></th>`),n+="</tr></thead><tbody>",e.forEach((e,t)=>{n+=`<tr data-row="${t}">`,a.forEach(a=>{n+=`<td contenteditable="true" data-row="${t}" data-key="${a}">${e.properties[a]??""}</td>`}),n+="</tr>"}),n+="</tbody></table>",t.innerHTML=n,"function"==typeof fltr_build&&fltr_build(),enableResizing(),enableRowSelection()}function enableRowSelection(){document.querySelectorAll("tbody tr").forEach(e=>{e.addEventListener("click",t=>{document.querySelectorAll("tbody tr").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),selectedRowIndex=+e.dataset.row;let a=filteredFeatures[selectedRowIndex];MapPreview.highlightFeature(a)})})}function enableResizing(){let e=document.querySelectorAll("th.resizable");e.forEach(e=>{let t=e.querySelector(".resize-handle"),a,n;t.addEventListener("mousedown",t=>{a=t.pageX,n=e.offsetWidth,document.body.style.cursor="col-resize";let r=t=>{let r=Math.max(40,n+(t.pageX-a));e.style.width=r+"px"},l=()=>{document.body.style.cursor="",window.removeEventListener("mousemove",r),window.removeEventListener("mouseup",l)};window.addEventListener("mousemove",r),window.addEventListener("mouseup",l)})})}function toggleMap(){let e=document.getElementById("mapPanel"),t=e.classList.toggle("expanded"),a=document.getElementById("tableWrapper");t?(a.style.maxHeight="32vh",a.style.height="",setTimeout(()=>{MapPreview.refresh(),geojsonData&&MapPreview.loadGeoJSON(geojsonData,handleMapFeatureClick)},300)):(a.style.maxHeight="520px",a.style.height="520px")}function handleMapFeatureClick(e){let t=filteredFeatures,a=t.indexOf(e);if(-1===a)return;let n=document.getElementById("tableWrapper"),r=n.querySelectorAll("tbody tr");r.forEach(e=>e.classList.remove("selected"));let l=r[a];l&&(l.classList.add("selected"),l.scrollIntoView({behavior:"smooth",block:"center"}))}document.addEventListener("input",e=>{if(e.target.matches('td[contenteditable="true"]')){let t=+e.target.dataset.row,a=e.target.dataset.key,n=filteredFeatures[t];n&&(n.properties[a]=e.target.innerText.trim())}}),document.getElementById("saveBtn").addEventListener("click",async()=>{let e=JSON.stringify(geojsonData,null,2);if("showSaveFilePicker"in window)try{let t=await window.showSaveFilePicker({suggestedName:"edited.geojson",types:[{description:"GeoJSON",accept:{"application/geo+json":[".geojson"],"application/json":[".json"]}}]}),a=await t.createWritable();await a.write(e),await a.close(),alert("File saved!");return}catch(n){console.warn(n)}let r=new Blob([e],{type:"application/json"}),l=document.createElement("a");l.href=URL.createObjectURL(r),l.download="edited.geojson",l.click(),URL.revokeObjectURL(l.href)}),document.addEventListener("DOMContentLoaded",()=>{MapPreview.initMap(),MapPreview.refresh()});