<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GeoJSON Attribute Editor + Map Preview</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
  :root { --font-size: 14px; }

  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f6f6f6;
  }

  h1 { text-align: center; }

  #controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
    gap: 10px;
  }

  #tableWrapper {
    max-height: 32vh;
    overflow: auto;
    border: 1px solid #ccc;
    background: white;
    position: relative;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
    min-width: max-content;
    font-size: var(--font-size);
  }

  th, td {
    border: 1px solid #ccc;
    padding: 6px 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  thead {
    position: sticky;
    top: 0;
    z-index: 5;
  }

  thead th { background: #eee; }

  th.resizable {
    position: relative;
  }

  th.resizable .resize-handle {
    position: absolute;
    right: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: col-resize;
    user-select: none;
  }

  td[contenteditable="true"] {
    background-color: #fff;
  }

  button, select, input[type=file], input[type=text] {
    padding: 6px 10px;
    border-radius: 4px;
  }

  button {
    border: none;
    background: #0078d4;
    color: white;
    cursor: pointer;
  }

  button:hover { background: #005fa3; }

  input[type=text] {
    border: 1px solid #ccc;
    width: 200px;
  }

  /* Column selector */
  #columnToggle { position: relative; }
  #columnList {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    padding: 10px;
    z-index: 2000;
    max-height: 300px;
    overflow: auto;
    min-width: 220px;
  }

  #columnList label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    margin: 2px 0;
    padding: 2px 4px;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
  }

  #columnList label:hover { background: #f2f2f2; }

  /* Accordion map panel */
  #mapPanel {
    height: 0;
    overflow: hidden;
    transition: height 0.3s ease;
    border: 1px solid #ccc;
    margin-top: 8px;
  }
  #mapPanel.expanded { height: 340px; }
  #map { width: 100%; height: 100%; }
</style>
</head>

<body>
<div id="controls">
  <input type="file" id="fileInput" accept=".geojson,.json" />
  <div>
    Font size:
    <select id="fontSizeSelect">
      <option value="12px">Small</option>
      <option value="14px" selected>Normal</option>
      <option value="16px">Large</option>
      <option value="18px">XL</option>
    </select>
  </div>
  <input type="text" id="searchInput" placeholder="Search..." />
  <div id="columnToggle">
    <button id="toggleColumnsBtn">Show/Hide Columns</button>
    <div id="columnList"></div>
  </div>
  <button id="toggleMapBtn"> Map</button>
  <button id="exportExcelBtn" style="display:none;">Export Excel</button>
  <button id="saveBtn" style="display:none;"> Save</button>
</div>

<div id="tableWrapper"><div id="tableContainer"></div></div>
<div id="mapPanel"><div id="map"></div></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Map module -->
<script src="mapPreview.js"></script>

<script>
let geojsonData = null;
let visibleColumns = {};
let filteredFeatures = [];
let selectedRowIndex = null;

document.getElementById('fileInput').addEventListener('change', handleFile);
document.getElementById('fontSizeSelect').addEventListener('change', e => {
  document.documentElement.style.setProperty('--font-size', e.target.value);
});
document.getElementById('toggleColumnsBtn').addEventListener('click', () => {
  const list = document.getElementById('columnList');
  list.style.display = list.style.display === 'block' ? 'none' : 'block';
});
document.getElementById('searchInput').addEventListener('input', handleSearch);
document.getElementById('toggleMapBtn').addEventListener('click', toggleMap);

document.getElementById('exportExcelBtn').addEventListener('click', () => {
  if (!geojsonData) return alert("No data to export.");

  // Prepare array of objects for Excel
  const features = filteredFeatures || geojsonData.features;
  const keys = Object.keys(features[0].properties).filter(k => visibleColumns[k]);
  const data = features.map(f => {
    const obj = {};
    keys.forEach(k => obj[k] = f.properties[k] ?? '');
    return obj;
  });

  // Create worksheet and workbook
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Attributes");

  // Trigger download
  XLSX.writeFile(wb, "geojson_attributes.xlsx");
});

async function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  geojsonData = JSON.parse(text);
  const feats = geojsonData.features;
  if (!feats?.length) return alert('No features found in GeoJSON.');
  const keys = Object.keys(feats[0].properties);
  visibleColumns = Object.fromEntries(keys.map(k => [k, true]));
  filteredFeatures = feats;
  renderColumnList(keys);
  renderTable();
  MapPreview.loadGeoJSON(geojsonData, handleMapFeatureClick);
  document.getElementById('saveBtn').style.display = 'inline-block';
  document.getElementById('exportExcelBtn').style.display = 'inline-block';
}

function renderColumnList(keys) {
  const list = document.getElementById('columnList');
  list.innerHTML = '';
  keys.forEach(k => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" checked data-key="${k}"><span>${k}</span>`;
    list.appendChild(label);
  });
  list.addEventListener('change', e => {
    if (e.target.matches('input[type=checkbox]')) {
      const key = e.target.dataset.key;
      visibleColumns[key] = e.target.checked;
      renderTable();
    }
  });
}

function handleSearch(e) {
  const q = e.target.value.trim().toLowerCase();
  if (!q) filteredFeatures = geojsonData.features;
  else {
    filteredFeatures = geojsonData.features.filter(f =>
      Object.entries(f.properties).some(
        ([k, v]) => visibleColumns[k] && String(v ?? '').toLowerCase().includes(q)
      )
    );
  }
  renderTable();
}

function renderTable() {
  const feats = filteredFeatures;
  const tableContainer = document.getElementById('tableContainer');
  if (!feats.length) {
    tableContainer.innerHTML = "<p style='padding:10px;'>No matching records.</p>";
    return;
  }

  const keys = Object.keys(feats[0].properties).filter(k => visibleColumns[k]);
  let html = '<table><thead><tr>';
  keys.forEach(k => (html += `<th class="resizable">${k}<div class="resize-handle"></div></th>`));
  html += '</tr></thead><tbody>';
  feats.forEach((f, i) => {
    html += `<tr data-row="${i}">`;
    keys.forEach(k => {
      html += `<td contenteditable="true" data-row="${i}" data-key="${k}">${f.properties[k] ?? ''}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  tableContainer.innerHTML = html;

  enableResizing();
  enableRowSelection();
}

function enableRowSelection() {
  document.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('click', e => {
      document.querySelectorAll('tbody tr').forEach(r => r.classList.remove('selected'));
      row.classList.add('selected');
      selectedRowIndex = +row.dataset.row;
      const feature = filteredFeatures[selectedRowIndex];
      MapPreview.highlightFeature(feature);
    });
  });
}

document.addEventListener('input', e => {
  if (e.target.matches('td[contenteditable="true"]')) {
    const row = +e.target.dataset.row;
    const key = e.target.dataset.key;
    const feature = filteredFeatures[row];
    if (feature) feature.properties[key] = e.target.innerText.trim();
  }
});

document.getElementById('saveBtn').addEventListener('click', async () => {
  const jsonString = JSON.stringify(geojsonData, null, 2);
  if ('showSaveFilePicker' in window) {
    try {
      const handle = await window.showSaveFilePicker({
        suggestedName: 'edited.geojson',
        types: [{ description: 'GeoJSON', accept: { 'application/geo+json': ['.geojson'], 'application/json': ['.json'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(jsonString);
      await writable.close();
      alert('File saved!');
      return;
    } catch (err) { console.warn(err); }
  }
  const blob = new Blob([jsonString], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'edited.geojson';
  a.click();
  URL.revokeObjectURL(a.href);
});

function enableResizing() {
  const ths = document.querySelectorAll('th.resizable');
  ths.forEach(th => {
    const handle = th.querySelector('.resize-handle');
    let startX, startWidth;
    handle.addEventListener('mousedown', e => {
      startX = e.pageX;
      startWidth = th.offsetWidth;
      document.body.style.cursor = 'col-resize';
      const move = ev => {
        const newW = Math.max(40, startWidth + (ev.pageX - startX));
        th.style.width = newW + 'px';
      };
      const up = () => {
        document.body.style.cursor = '';
        window.removeEventListener('mousemove', move);
        window.removeEventListener('mouseup', up);
      };
      window.addEventListener('mousemove', move);
      window.addEventListener('mouseup', up);
    });
  });
}

function toggleMap() {
  const panel = document.getElementById('mapPanel');
  const expanded = panel.classList.toggle('expanded');
  if (expanded && geojsonData) {
    setTimeout(() => {
      MapPreview.loadGeoJSON(geojsonData, handleMapFeatureClick);
      MapPreview.refresh(); // fix map sizing
    }, 250);
  }
}

// highlight table row when a map feature is clicked
function handleMapFeatureClick(feature) {
  const feats = filteredFeatures;
  const rowIndex = feats.indexOf(feature);
  if (rowIndex === -1) return;
  const tableWrapper = document.getElementById('tableWrapper');
  const rows = tableWrapper.querySelectorAll('tbody tr');
  rows.forEach(r => r.classList.remove('selected'));
  const row = rows[rowIndex];
  if (row) {
    row.classList.add('selected');
    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}
</script>

<style>
  /* highlight selection */
  tr.selected td {
    background-color: #d0e7ff !important;
  }
</style>

</body>
</html>
